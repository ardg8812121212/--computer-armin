
@if (apiKeyError()) {
  <div class="bg-red-900/80 backdrop-blur-sm border border-red-500 text-red-200 px-4 py-3 rounded-lg relative" role="alert">
    <strong class="font-bold">خطای پیکربندی!</strong>
    <span class="block sm:inline">{{ apiKeyError() }}</span>
  </div>
} @else {
  <div class="flex flex-col h-[calc(100vh-250px)] max-w-4xl mx-auto bg-black/30 backdrop-blur-lg rounded-lg shadow-2xl border border-white/10">
    <div #chatContainer class="flex-grow p-6 overflow-y-auto space-y-6">
      @if (messages().length === 0) {
        <div class="text-center text-gray-400">
          <p class="text-xl">به Armin AI خوش آمدید!</p>
          <p>چگونه می‌توانم امروز به شما کمک کنم؟</p>
        </div>
      }
      @for (message of messages(); track message.id) {
        <div class="flex items-start gap-3 chat-bubble" [class.justify-end]="message.role === 'user'">
          @if(message.role === 'user') {
            <button (click)="toggleEdit(message.id)" class="mt-2 text-gray-400 hover:text-cyan-400 transition-colors p-1 shrink-0">
                <span class="material-symbols-outlined text-base">edit</span>
            </button>
          }
          <div 
            class="max-w-lg lg:max-w-xl px-5 py-3 rounded-2xl w-full" 
            [class.bg-cyan-600]="message.role === 'user'" 
            [class.text-white]="message.role === 'user'"
            [class.bg-gray-900/80]="message.role === 'model'"
            [class.text-gray-200]="message.role === 'model'"
          >
            @if(message.isEditing) {
              <textarea #editTextarea class="w-full bg-transparent border-b border-white/50 focus:outline-none resize-none" rows="3" (keydown.enter)="saveEdit(message.id, editTextarea.value); $event.preventDefault()">{{message.text}}</textarea>
              <div class="text-right mt-2">
                  <button (click)="saveEdit(message.id, editTextarea.value)" class="text-xs bg-white/20 px-2 py-1 rounded">ذخیره</button>
                  <button (click)="toggleEdit(message.id)" class="text-xs mr-2">لغو</button>
              </div>
            } @else {
              <p class="whitespace-pre-wrap">{{ message.text }}</p>
            }
            @if(message.groundingChunks?.length) {
              <div class="mt-4 border-t border-white/20 pt-3">
                <h4 class="text-xs font-bold mb-2 text-gray-300">منابع (جستجوی گوگل):</h4>
                <div class="space-y-2">
                  @for(chunk of message.groundingChunks; track $index) {
                    <a [href]="chunk.web.uri" target="_blank" class="block text-xs text-cyan-300 hover:underline truncate" [title]="chunk.web.title">
                      {{ chunk.web.title || chunk.web.uri }}
                    </a>
                  }
                </div>
              </div>
            }
          </div>
        </div>
      }
      @if (isLoading()) {
        <div class="flex justify-start">
            <div class="bg-gray-900/80 px-5 py-3 rounded-2xl flex items-center space-x-3 space-x-reverse">
                <div class="typing-dot"></div>
                <div class="typing-dot" style="animation-delay: 0.2s;"></div>
                <div class="typing-dot" style="animation-delay: 0.4s;"></div>
            </div>
        </div>
      }
    </div>
    <div class="p-4 bg-black/30 border-t border-white/10">
       <div class="flex items-center justify-center mb-3">
          <label class="flex items-center cursor-pointer">
            <input type="checkbox" [checked]="useGoogleSearch()" (change)="useGoogleSearch.set($any($event.target).checked)" class="w-4 h-4 rounded accent-cyan-500 bg-gray-700 border-gray-600">
            <span class="mr-2 text-sm text-gray-300">استفاده از جستجوی گوگل</span>
          </label>
        </div>
      <form (submit)="sendMessage()" class="flex items-center gap-4">
        <input
          type="text"
          [(ngModel)]="currentMessage"
          name="message"
          placeholder="پیام خود را تایپ کنید..."
          class="flex-grow bg-gray-900/70 text-gray-200 border border-white/20 rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"
          [disabled]="isLoading()"
        />
        <button
          type="submit"
          class="bg-cyan-600 text-white rounded-full p-3 hover:bg-cyan-500 disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors duration-200"
          [disabled]="isLoading() || currentMessage().trim() === ''"
        >
          <span class="material-symbols-outlined">send</span>
        </button>
      </form>
    </div>
  </div>
}
