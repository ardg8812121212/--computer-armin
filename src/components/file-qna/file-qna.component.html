
@if (apiKeyError()) {
  <div class="bg-red-900/80 backdrop-blur-sm border border-red-500 text-red-200 px-4 py-3 rounded-lg relative" role="alert">
    <strong class="font-bold">خطای پیکربندی!</strong>
    <span class="block sm:inline">{{ apiKeyError() }}</span>
  </div>
} @else {
  <div class="flex flex-col h-[calc(100vh-250px)] max-w-4xl mx-auto">
    
    @if (!uploadedFile()) {
      <div class="flex-grow flex items-center justify-center">
        <div class="w-full max-w-lg p-8 text-center bg-black/30 backdrop-blur-lg border-2 border-dashed border-white/20 rounded-lg">
          <span class="material-symbols-outlined text-6xl text-gray-400">upload_file</span>
          <h2 class="mt-4 text-xl font-medium text-gray-200">فایل خود را آپلود کنید</h2>
          <p class="mt-2 text-sm text-gray-400">فایل PDF، Word یا عکس خود را برای تحلیل بکشید و رها کنید یا انتخاب کنید.</p>
          <label for="file-upload" class="mt-6 inline-block cursor-pointer bg-cyan-600 text-white rounded-full py-3 px-6 hover:bg-cyan-500 transition-colors duration-200">
            انتخاب فایل
          </label>
          <input id="file-upload" type="file" class="hidden" (change)="onFileChange($event)" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.txt">
          @if (fileError()) {
            <div class="mt-4 bg-red-900/80 border border-red-500 text-red-200 px-4 py-3 rounded-lg text-sm" role="alert">
              <strong class="font-bold">خطا: </strong>
              <span>{{ fileError() }}</span>
            </div>
          }
        </div>
      </div>
    } @else {
      <!-- Chat Interface -->
      <div class="flex flex-col flex-grow bg-black/30 backdrop-blur-lg rounded-lg shadow-2xl overflow-hidden border border-white/10">
        <div class="p-4 bg-black/20 border-b border-white/10 flex justify-between items-center">
          <div class="flex items-center gap-3 min-w-0">
            <span class="material-symbols-outlined text-cyan-400">description</span>
            <span class="font-bold text-gray-200 truncate">{{ uploadedFile()?.name }}</span>
          </div>
          <button (click)="removeFile()" class="text-gray-400 hover:text-white transition-colors flex-shrink-0">
            <span class="material-symbols-outlined">close</span>
          </button>
        </div>

        <div #chatContainer class="flex-grow p-6 overflow-y-auto space-y-6">
          @if (messages().length === 0) {
            <div class="text-center text-gray-400">
              <p class="text-lg">فایل با موفقیت بارگذاری شد.</p>
              <p>حالا می‌توانید سوالات خود را در مورد این فایل بپرسید.</p>
            </div>
          }
          @for (message of messages(); track message.id) {
            <div class="flex items-start gap-3 chat-bubble" [class.justify-end]="message.role === 'user'">
               @if(message.role === 'user') {
                <button (click)="toggleEdit(message.id)" class="mt-2 text-gray-400 hover:text-cyan-400 transition-colors p-1 shrink-0">
                    <span class="material-symbols-outlined text-base">edit</span>
                </button>
              }
              <div 
                class="max-w-lg lg:max-w-xl px-5 py-3 rounded-2xl w-full" 
                [class.bg-cyan-600]="message.role === 'user'" 
                [class.text-white]="message.role === 'user'"
                [class.bg-gray-900/80]="message.role === 'model'"
                [class.text-gray-200]="message.role === 'model'"
              >
                @if(message.isEditing) {
                  <textarea #editTextarea class="w-full bg-transparent border-b border-white/50 focus:outline-none resize-none" rows="3" (keydown.enter)="saveEdit(message.id, editTextarea.value); $event.preventDefault()">{{message.text}}</textarea>
                  <div class="text-right mt-2">
                      <button (click)="saveEdit(message.id, editTextarea.value)" class="text-xs bg-white/20 px-2 py-1 rounded">ذخیره</button>
                      <button (click)="toggleEdit(message.id)" class="text-xs mr-2">لغو</button>
                  </div>
                } @else {
                  <p class="whitespace-pre-wrap">{{ message.text }}</p>
                }
              </div>
            </div>
          }
          @if (isLoading()) {
            <div class="flex justify-start">
                <div class="bg-gray-900/80 px-5 py-3 rounded-2xl flex items-center space-x-3 space-x-reverse">
                    <div class="typing-dot"></div>
                    <div class="typing-dot" style="animation-delay: 0.2s;"></div>
                    <div class="typing-dot" style="animation-delay: 0.4s;"></div>
                </div>
            </div>
          }
        </div>
        <div class="p-4 bg-black/30 border-t border-white/10">
          <form (submit)="sendMessage()" class="flex items-center gap-4">
            <input
              type="text"
              [(ngModel)]="currentMessage"
              name="message"
              placeholder="در مورد فایل بپرسید..."
              class="flex-grow bg-gray-900/70 text-gray-200 border border-white/20 rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-cyan-500 transition"
              [disabled]="isLoading()"
            />
            <button
              type="submit"
              class="bg-cyan-600 text-white rounded-full p-3 hover:bg-cyan-500 disabled:bg-gray-500 disabled:cursor-not-allowed transition-colors duration-200"
              [disabled]="isLoading() || currentMessage().trim() === ''"
            >
              <span class="material-symbols-outlined">send</span>
            </button>
          </form>
        </div>
      </div>
    }

  </div>
}
